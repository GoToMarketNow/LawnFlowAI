# LawnFlow Architecture Overview

This document provides a high-level overview of the LawnFlow application architecture, focusing on the evolution towards a microservices-based agentic system. It serves as a starting point for new team members to understand the system's design principles, key components, and development guidelines.

## 1. High-Level System Architecture

LawnFlow is transitioning from a monolithic application towards a more modular, microservices-oriented architecture, particularly for its AI-powered agentic workflows.

**Key Architectural Goals:**
*   **Modularity:** Decompose large components into smaller, independent services.
*   **Scalability:** Enable individual services to scale independently based on demand.
*   **Maintainability:** Improve code organization, reduce cognitive load, and facilitate easier updates.
*   **Resilience:** Isolate failures to prevent cascading impacts across the entire system.
*   **Agent-Centric:** Support the development and deployment of highly optimized, autonomous agents.

## 2. Agentic Architecture (Plan and Execute)

The core of LawnFlow's intelligent automation lies in its "Plan and Execute" agentic architecture.

*   **Supervisor:** (Resides in `server/orchestrator/supervisor.ts` in the monolith, will be extracted) Responsible for:
    *   Receiving events (e.g., missed calls, inbound SMS, web leads).
    *   Utilizing a Large Language Model (LLM) to generate a high-level plan of action.
    *   Consulting business policies and configurations to determine automation levels.
*   **Runner:** (Resides in `server/orchestrator/runner.ts` in the monolith, will be extracted) Responsible for:
    *   Executing the steps outlined in the plan generated by the Supervisor.
    *   Interacting with specialist agents and external tools (e.g., CRM, FSM systems).
    *   Enforcing policies (e.g., human-in-the-loop approvals).
*   **Specialist Agents:** Individual agents designed to handle specific tasks (e.g., billing, quoting, scheduling). These agents are being extracted into the `agent-service`.

## 3. The New `agent-service` Microservice

The `agent-service` is the first key microservice extracted from the monolith. Its purpose is to host all AI-powered specialist agents, providing a dedicated environment for their execution and management.

*   **API Contract:** Defined in [Agent Service API Documentation](agent-service-api.md). It exposes endpoints for:
    *   `POST /events`: To trigger agent workflows.
    *   `POST /actions/{id}/approve`: To approve human-in-the-loop actions.
    *   `POST /actions/{id}/reject`: To reject human-in-the-loop actions.
*   **Agent Logic:** All agent implementations (e.g., billing, quoting, scheduling) are consolidated within `agent-service/src/agents`.
*   **Dependencies:** External dependencies (database access, external APIs) are abstracted through mock services for isolation, with a long-term plan to interact with dedicated microservices (e.g., `storage-service`, `geo-service`).
*   **Standard Interface:** All agents within the `agent-service` adhere to a standard interface for consistency and ease of development. Refer to [Agent Development Guidelines](agent-development-guidelines.md).

## 4. Service Layer Architecture

To improve separation of concerns and reduce code duplication, a formal service layer is being introduced.

*   **Purpose:** Encapsulate business logic, orchestrate operations, and abstract data access.
*   **Structure:** Defined in [Service Layer Guidelines](service-layer-guidelines.md).
*   **Implementation:** Services within `agent-service/src/services` (e.g., `ConfigurationService`, `GeoService` mocks) encapsulate specific functionalities.

## 5. Configuration Management

Business logic parameters and agent-specific settings are externalized into a `Configuration` service.

*   **Schema:** The `agentConfigurations` table in `@shared/schema.ts` stores agent-specific settings.
*   **Service:** The `ConfigurationService` (`agent-service/src/services/configuration.ts`) provides an API to access these configurations.
*   **UI:** A dedicated UI is planned for managing these configurations, as specified in [Configuration Management UI Specification](configuration-management-ui.md). This enables Product Managers to update business rules without code changes.

## 6. Evaluation and Reliability

A robust evaluation framework is critical for ensuring agent performance and reliability.

*   **Golden Dataset:** Test cases with predefined inputs and expected outputs serve as a baseline.
*   **Automated Pipeline:** Tests run against the golden dataset to quickly identify regressions.
*   **Performance Metrics:** Key metrics like confidence, latency, and cost are tracked.
*   **Alerting:** Thresholds are defined to trigger alerts on performance degradation.

## 7. Frontend Architecture and User Experience

The frontend is built with React and Tailwind CSS, prioritizing user experience.

*   **Design System:** A comprehensive design system ensures consistency and accelerates development. Refer to [Design System and Component Library Specification](design-system-spec.md).
*   **Real-time Updates:** A strategy for implementing real-time updates (e.g., WebSockets) is outlined in [Real-time Updates Implementation Strategy](real-time-updates.md).
*   **Performance Optimization:** Recommendations for optimizing frontend performance are detailed in [Frontend Performance Optimization Strategy](frontend-performance-optimization.md).
*   **Responsive Design:** A mobile-first approach ensures usability across devices, documented in [Responsive Design and Mobile Usability Strategy](responsive-design-strategy.md).

## 8. Development Workflow

*   **TypeScript:** All new code is written in TypeScript for type safety and improved developer experience.
*   **Testing:** Unit and integration tests are mandatory for all new features and bug fixes.
*   **Documentation:** Comprehensive documentation is maintained to facilitate onboarding and knowledge sharing.

This architectural shift aims to create a more agile, scalable, and resilient LawnFlow platform, capable of delivering highly optimized agent experiences.
